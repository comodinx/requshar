/*! requshar
    v0.1.0 (c) Nicolas Molina
    MIT License
*/
"use strict";var isServer="undefined"==typeof window,root=isServer?{}:window;!function(a,b){isServer?module.exports=b(require("underscore"),a):root[a]=b(root._,a)}("Requshar",function(a,b){function c(b,c){var d,e,f=this;return e=b&&a.has(b,"constructor")?b.constructor:function(){return f.apply(this,arguments)},a.extend(e,f,c),d=function(){this.constructor=e},d.prototype=f.prototype,e.prototype=new d,b&&a.extend(e.prototype,b),e.__super__=f.prototype,e}function d(b){this.options=a.defaults(b||{},h)}function e(a){this.options=a||{}}var f,g=root[b],h={defaultErrorCode:598,parseJSON:!1,debug:!1,logger:console};a.extend(d.prototype,{request:function(b,c,d){var e;return c instanceof Function&&(d=c,c={}),e=new f(a.defaults(a.pick(c,a.keys(h)),this.options)),e.request(a.defaults({url:b},c,{method:"get"}),d)},json:function(b,c,d){return c instanceof Function&&(d=c,c={}),this.request(b,a.defaults({parseJSON:!0},c,{method:"get"}),d)},file:function(a,b,c,d,e){if(!isServer)throw"Restler library not available on the client";return restler.file(a,b,c,d,e)}}),a.each(["get","post","put","patch","delete"],function(b){d.prototype[b]=function(c,d,e){return d instanceof Function&&(e=d,d={}),this.request(c,a.defaults({_method:b,method:b},d),e)}}),d.noConflict=function(){return root[b]=g,this},d.extend=c,a.extend(e.prototype,{request:function(b,c){return b instanceof Function&&(c=b,b={}),this.reqTimeStart=a.now(),this.callback=c||a.noop,b=this.prepare(b),this.makeRequest(b),this},prepare:function(a){return a=this.defaults(a),a.query=a.query||{},"GET"!==a.method.toUpperCase()&&(a.data=a.data||{}),a},makeRequest:function(a,b){throw new Error("requshar.makeRequest is not implement")},check:function(a,b,c){return a?this.fail(a,b):void this.success(b,this.prepareBody(c))},success:function(a,b){this.callback(null,a,b)},fail:function(a,b){this.callback(a,b)},defaults:function(b,c){return b=a.clone(b),b.path&&(b.url=b.path,delete b.path),this.options.baseUrl&&!~b.url.indexOf(this.options.baseUrl)&&(b.url=this.options.baseUrl+b.url),a.defaults(b,{method:"get",headers:{}}),a.defaults(b.headers,this.options.headers||{}),!b.body||b.headers["Content-Type"]&&"application/json"!==b.headers["Content-Type"]||(b.json=b.body),"GET"===b.method.toUpperCase()&&(delete b.json,delete b.body,delete b.data),isServer||(b.type=b.method,delete b.method),b},elapsed:function(b,c){return c?c:a.now()-b},prepareBody:function(a){if(this.options.parseJSON)try{a=JSON.parse(a)}catch(b){this.options.debug&&this.options.logger.warn("Not parse body "+b.toString())}return a}}),e.extend=c;var i=function(){function b(b){return b=this.defaults(b),b=d(b),this.succeeded=b.done||a.noop,this.failed=b.fail||a.noop,delete b.done,delete b.fail,b}function c(a){function b(b,c,e){this.options.debug&&(d=this.elapsed(this.reqTimeStart,d),this.options.logger.log("%s %d %s %s ms",a.type.toUpperCase(),e.status,a.url,d)),this.succeeded.apply(this,arguments),this.check(null,f(e,c),e.responseText)}function c(b,c,e){this.options.debug&&(d=this.elapsed(this.reqTimeStart,d),this.options.logger.error("%s %d %s %j %s ms",a.type.toUpperCase(),b.status,a.url,e,d)),"timeout"===c&&a.onTimeout?a.onTimeout.apply(this,arguments):this.failed.apply(this,arguments),this.check(g(e,b),f(b),b.responseText)}var d;this.req=$.ajax(a).done(b.bind(this)).fail(c.bind(this))}function d(b){var c;return b.query&&(b.url=utils.url.params(b.url,b.query)),b.data&&b.multipart&&(c=new FormData,a.each(a.keys(b.data),function(a){c.append(a,b.data[a])}),b.data=c),b}function f(a,b){return{readyState:a.readyState,responseText:a.responseText,statusCode:a.status,statusText:a.statusText,status:b,res:a}}function g(a,b){return a||{statusCode:b.status}}return e.extend({prepare:b,makeRequest:c})}(),j=function(){function b(b){function e(a,c){this.options.debug&&(g=this.elapsed(this.reqTimeStart,g),this.options.logger.log("%s %d %s %s ms",b.method.toUpperCase(),c.statusCode,url,g)),this.check(null,c,a)}function f(a,c){this.options.debug&&(g=this.elapsed(this.reqTimeStart,g),this.options.logger.error("%s %d %s %j %s ms",b.method.toUpperCase(),c.statusCode,url,a,g)),this.check(a,c)}var g;this.req=(c||(c=require(d))).request(b.url,a.omit(b,"url")).on("success",e.bind(this)).on("fail",f.bind(this)).on("error",f.bind(this)),void 0!==b.timeout&&b.onTimeout&&this.req.on("timeout",b.onTimeout)}var c,d="restler";return e.extend({makeRequest:b})}();return f=isServer?j:i,d});